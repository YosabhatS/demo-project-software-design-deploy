<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Kitchen Display System (KDS)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        header {
            background-color: #2254c5;
            color: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .staff-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .staff-info {
            font-weight: bold;
            font-size: 0.95em;
        }

        h1 { margin: 0; font-size: 1.6em; }

        #logoutBtn {
            background: #dc3545;
            border: none;
            color: white;
            border-radius: 6px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        #logoutBtn:hover { background: #c82333; }

        #lastUpdated {
            font-size: 0.9em;
            color: #555;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        #ordersContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }

        .order-card {
            background: white;
            border: 1px solid #e3e6ef;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            transition: all 0.3s;
        }

        .order-card.new {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.4);
            animation: highlight 1.5s ease-in-out infinite alternate;
        }

        @keyframes highlight {
            from { box-shadow: 0 0 12px rgba(0,123,255,0.6); }
            to { box-shadow: 0 0 5px rgba(0,123,255,0.1); }
        }

        .order-card h2 {
            font-size: 1.3em;
            margin: 0 0 10px;
            color: #007bff;
        }

        .table-id {
            font-weight: bold;
            color: #0056b3;
        }

        .status {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .order-card ul {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .order-card ul li {
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
            font-weight: 500;
        }

        .time-display {
            font-size: 0.9em;
            color: #666;
        }

        button.complete-btn {
            background: #28a745;
            color: white;
            border: none;
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }

        button.complete-btn:hover { background: #218838; }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
<header>
    <h1>üç≥ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß (KDS)</h1>
    <div class="staff-controls">
        <div class="staff-info" id="staffInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...</div>
        <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</header>

<p id="lastUpdated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
<div id="log" class="error-message"></div>

<div id="ordersContainer">
    <p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà...</p>
</div>

<script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö login
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'staff_login.html';
    }

    const staffInfoEl = document.getElementById('staffInfo');
    const staffDisplayName = localStorage.getItem('staffDisplayName');
    const staffRole = localStorage.getItem('staffRole');
    staffInfoEl.textContent = staffDisplayName 
        ? `${staffDisplayName} (${staffRole ?? 'EMPLOYEE'})`
        : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...';

    const ORDER_API_URL = 'http://localhost:8082/api/orders';
    const KITCHEN_API_URL = `${ORDER_API_URL}/kitchen`;
    const UPDATE_INTERVAL = 5000;
    let currentOrderIds = new Set();

    // logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('staffDisplayName');
            localStorage.removeItem('staffRole');
            window.location.href = 'staff_login.html';
        }
    });

    function logMessage(msg, isError = false) {
        const log = document.getElementById('log');
        if (isError) {
            log.textContent = msg;
            log.style.display = 'block';
        } else {
            log.style.display = 'none';
            console.log(msg);
        }
    }

    async function fetchKitchenOrders() {
        try {
            const res = await fetch(KITCHEN_API_URL);
            if (res.ok) {
                const orders = await res.json();
                renderOrders(orders);
                logMessage('');
            } else {
                logMessage(`‚ùå Error ${res.status}: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ`, true);
            }
        } catch (err) {
            logMessage(`‚ùå Network Error: ${err.message}`, true);
        }
        document.getElementById('lastUpdated').textContent = 
            `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`;
    }

    function renderOrders(orders) {
        const container = document.getElementById('ordersContainer');
        if (!orders || orders.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:#28a745;"></p>`;
            currentOrderIds.clear();
            return;
        }

        const newOrderIds = new Set(orders.map(o => o.id));
        container.querySelectorAll('.order-card').forEach(card => {
            const id = parseInt(card.dataset.orderId);
            if (!newOrderIds.has(id)) card.remove();
        });

        orders.forEach(order => {
            const isNew = !currentOrderIds.has(order.id);
            let card = document.querySelector(`.order-card[data-order-id="${order.id}"]`);
            if (!card) {
                card = document.createElement('div');
                container.prepend(card);
            }

            const items = order.items?.length
                ? order.items.map(i => {
                    const name = i.menuItemDetails ? i.menuItemDetails.name : `‡πÄ‡∏°‡∏ô‡∏π #${i.menuId}`;
                    return `<li>${i.quantity} √ó ${name}</li>`;
                }).join('')
                : '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢</li>';

            card.className = `order-card ${isNew ? 'new' : ''}`;
            card.dataset.orderId = order.id;
            card.innerHTML = `
                <h2>Order #${order.id} <span class="table-id">(‡πÇ‡∏ï‡πä‡∏∞ ${order.tableId})</span></h2>
                <p class="status">${order.status}</p>
                <p class="time-display">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á: ${new Date(order.createdAt).toLocaleTimeString('th-TH')}</p>
                <ul>${items}</ul>
                <button class="complete-btn" onclick="markAsCompleted(${order.id})">‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            `;
            if (isNew) setTimeout(() => card.classList.remove('new'), 1500);
        });

        currentOrderIds = newOrderIds;
    }

    async function markAsCompleted(orderId) {
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≥ Order #${orderId} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô?`)) return;
        try {
            const res = await fetch(`${ORDER_API_URL}/${orderId}/status/completed`, { method: 'PUT' });
            if (res.ok) {
                document.querySelector(`.order-card[data-order-id="${orderId}"]`)?.remove();
                fetchKitchenOrders();
            } else {
                logMessage(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ (${res.status})`, true);
            }
        } catch (err) {
            logMessage(`‚ùå Network Error: ${err.message}`, true);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchKitchenOrders();
        setInterval(fetchKitchenOrders, UPDATE_INTERVAL);
    });
</script>
</body>
</html>
