<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px 15px 80px 15px;   background-image: url('images/bg-client.png');
    background-size: cover; }
        .header { background-color: #2254c5; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .menu-item, .order-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .item-details h3 { margin: 0 0 5px 0; color: #333; }
        .item-details p { margin: 0; color: #555; font-size: 0.9em; }
        .controls { display: flex; align-items: center; }
        .controls button { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 0 5px; }
        .controls input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 5px; }
        .controls button.add { background: #28a745; }
        #order-summary { position: fixed; bottom: 0; left: 0; right: 0; background-color: #343a40; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 10px; }
        #order-summary button { background: #2254c5; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .log-message { margin-top: 15px; padding: 10px; border-radius: 5px; }
        .log-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .log-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    #order-summary {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 2px solid #007bff;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 100;
}
    	
    
    </style>
</head>
<body>

    <div class="header">
        <h1>üçΩ ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
        <p>‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <strong id="tableIdDisplay">--</strong></p>
    </div>

    <div id="menuList">
        <h2>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</p>
    </div>

    <div id="existingOrders">
        <h2>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h2>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

<!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
<div id="order-list">
    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á -->
</div>

<!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏à‡∏≠) -->
<div id="order-summary">
    <div>
        <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà: <strong id="totalItemsDisplay">0</strong></span>
    </div>
    <div>
        <button onclick="submitOrder()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        <span style="margin-left: 12px; font-size: 0.9em; color: black;">
            üí° ‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå
        </span>
    </div>
</div>


    <div class="log-message" id="log"></div>

    <script>
        const ORDER_API_URL = 'http://localhost:8082/api/orders';   // Service ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö client
        const DATA_API_URL = 'http://localhost:8085/api/data';      // Service ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• order/menu
        const TABLE_ID = new URLSearchParams(window.location.search).get('tableId');

        let menuItems = [];
        let orderItems = {};
        let activeOrders = [];

        document.getElementById('tableIdDisplay').innerText = TABLE_ID || '‡πÑ‡∏°‡πà‡∏û‡∏ö';

        // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ï‡πä‡∏∞
        async function fetchTableName() {
            if (!TABLE_ID) return;
            try {
                const response = await fetch(`${ORDER_API_URL}/tables/${TABLE_ID}`);
                if (response.ok) {
                    const table = await response.json();
                    document.getElementById('tableIdDisplay').innerText = table.tableNumber;
                }
            } catch (_) {}
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π
        async function fetchMenuItems() {
            try {
                const response = await fetch(`${ORDER_API_URL}/menu`);
                if (response.ok) {
                    menuItems = await response.json();
                    renderMenu();
                }
            } catch (error) {
                logMessage(`‚ùå Network Error: ${error.message}`, true);
            }
        }

        function renderMenu() {
            const listElement = document.getElementById('menuList');
            let html = '<h2>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>';
            if (menuItems.length === 0) {
                listElement.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π</p>';
                return;
            }
            menuItems.forEach(item => {
                const qty = orderItems[item.id] || 0;
                const imageSrc = `http://localhost:8085${item.imageUrl || '/images/default.jpg'}`;
                html += `
                    <div class="menu-item">
                	<img src="${imageSrc}" alt="${item.name}" 
                    style="width:80px; height:80px; object-fit:cover; border-radius:8px; margin-right:10px;">
               <div class="item-details" style="flex:1;">
                   <h3>${item.name}</h3>
                   <p>‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price.toFixed(2)} ‡∏ö‡∏≤‡∏ó</p>
               </div>
               <div class="controls">
                   <button onclick="updateQuantity(${item.id}, -1)">-</button>
                   <input type="number" id="qty-${item.id}" value="${qty}" readonly>
                   <button class="add" onclick="updateQuantity(${item.id}, 1)">+</button>
               </div>
           </div>
                `;
            });
            listElement.innerHTML = html;
            updateSummary();
        }

        function updateQuantity(menuId, change) {
            const input = document.getElementById(`qty-${menuId}`);
            let newQty = (orderItems[menuId] || 0) + change;
            if (newQty < 0) newQty = 0;
            orderItems[menuId] = newQty;
            input.value = newQty;
            if (newQty === 0) delete orderItems[menuId];
            updateSummary();
        }

        function updateSummary() {
            const total = Object.values(orderItems).reduce((sum, qty) => sum + qty, 0);
            document.getElementById('totalItemsDisplay').innerText = total;
        }

        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
        async function submitOrder() {
            const items = Object.entries(orderItems).map(([menuId, quantity]) => ({ menuId: parseInt(menuId), quantity }));
            if (items.length === 0) {
                logMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô', true);
                return;
            }
            const body = { tableId: parseInt(TABLE_ID), items };
            try {
                const response = await fetch(ORDER_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (response.status === 201) {
                    logMessage(`‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
                    orderItems = {};
                    renderMenu();
                    fetchActiveOrders(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡∏°‡πà
                }
            } catch (error) {
                logMessage(`‚ùå Network Error: ${error.message}`, true);
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
        async function fetchActiveOrders() {
            try {
                const response = await fetch(`${DATA_API_URL}/orders/table/${TABLE_ID}/current`);
                if (response.ok) {
                    const orderInfo = await response.json();
                    activeOrders = orderInfo && orderInfo.items ? orderInfo.items : [];
                    renderActiveOrders();
                } else {
                    document.getElementById('existingOrders').innerHTML = '<h2>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h2><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                }
            } catch (error) {
                logMessage(`‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, true);
            }
        }

        function renderActiveOrders() {
            const container = document.getElementById('existingOrders');
            if (activeOrders.length === 0) {
                container.innerHTML = '<h2>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h2><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                return;
            }
            let html = '<h2>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h2>';
            activeOrders.forEach(item => {
                const menuName = item.menuItemDetails?.name || '‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
                const price = item.menuItemDetails?.price || 0;
                html += `
                    <div class="order-item">
                        <div class="item-details">
                            <h3>${menuName}</h3>
                            <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity} | ‡∏£‡∏≤‡∏Ñ‡∏≤: ${price.toFixed(2) * item.quantity} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }


        function logMessage(message, isError = false) {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('th-TH');
            log.className = isError ? 'log-message log-error' : 'log-message log-success';
            log.innerText = `[${timestamp}] ${message}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchTableName();
            fetchMenuItems();
            fetchActiveOrders();
        });
    </script>
</body>
</html>
