<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { color-scheme: light dark; }
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: #f4f6f8;
    color: #2c3e50;
}
header {
    background: #1f3a93;
    color: #fff;
    padding: 18px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}
header h1 { margin:0; font-size:1.6rem; }
.staff-info { font-size:0.95rem; }

main {
    display: grid;
    gap: 20px;
    padding: 24px;
}
@media (min-width: 960px) {
    main { grid-template-columns: 1.2fr 1fr; }
}
section {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 24px rgba(31,58,147,0.08);
}
h2 {
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.2rem;
}
button.primary {
    background: #f1c40f;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-weight: 600;
    cursor: pointer;
    color: #2c3e50;
}
button.secondary {
    background: transparent;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    color: inherit;
}
button:disabled { opacity:0.5; cursor:not-allowed; }

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
}
th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #ecf0f1; vertical-align: top; }
th { background: #f8f9fb; color:#2c3e50; }
.order-items { font-size:0.9rem; }
.order-items li { list-style:none; }
.status-pill {
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:0.8rem;
    background:#ffeaa7;
    color:#8e44ad;
}
.error-box {
    background:#f8d7da;
    color:#721c24;
    padding:12px;
    border-radius:8px;
    margin-top:12px;
    display:none;
}
.receipt-card {
    margin-top:16px;
    border:1px dashed #95a5a6;
    padding:16px;
    border-radius:10px;
    background:#fafafa;
}
.totals { text-align:right; margin-top:18px; font-size:1.1rem; font-weight:bold; }
.table-search { display:flex; gap:10px; margin-top:12px; }
.table-search input {
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.2);
}
.muted { color:#7f8c8d; }

/* Chart Layout */
.chart-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    align-items: flex-start;
    margin-top: 20px;
}
.chart-box {
    flex: 1 1 45%; 
    min-width: 350px;
    max-width: 400px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Pie Chart */
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
</head>

<body>
<header>
    <h1>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
    <div class="staff-info" id="staffInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...</div>
</header>

<main>
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô -->
    <section id="checkoutSection">
        <h2>üí≥ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô <button class="secondary" id="refreshPending">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h2>
        <p class="muted">‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</p>
        <div class="table-search">
            <input type="number" id="tableSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞" min="1" />
            <button class="secondary" id="filterBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            <button class="secondary" id="clearFilterBtn">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
        <div id="pendingError" class="error-box"></div>
        <table>
            <thead>
                <tr>
                    <th>Order</th>
                    <th>‡πÇ‡∏ï‡πä‡∏∞</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="pendingOrdersBody">
                <tr><td colspan="5" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>
        <div id="receiptContainer"></div>
    </section>

    <!-- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + ‡∏Å‡∏£‡∏≤‡∏ü -->
    <section>
        <h2>üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <button class="secondary" id="refreshSales">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></h2>
        <p class="muted">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
        <div id="salesError" class="error-box"></div>

        <div class="chart-container">
            <div class="chart-box">
                <canvas id="salesChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="menuPieChart"></canvas>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Order</th>
                    <th>‡πÇ‡∏ï‡πä‡∏∞</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á</th>
                </tr>
            </thead>
            <tbody id="salesBody">
                <tr><td colspan="5" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>
        <div class="totals">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: <span id="salesTotal">0.00</span> ‡∏ö‡∏≤‡∏ó</div>
    </section>
</main>

<script>
const API_BASE = '/api/orders';
const PENDING_ENDPOINT = `${API_BASE}/status/COMPLETED`;
const SALES_ENDPOINT = `${API_BASE}/status/PAID`;

const staffInfo = document.getElementById('staffInfo');
const pendingBody = document.getElementById('pendingOrdersBody');
const salesBody = document.getElementById('salesBody');
const pendingError = document.getElementById('pendingError');
const salesError = document.getElementById('salesError');
const receiptContainer = document.getElementById('receiptContainer');

document.getElementById('refreshPending').addEventListener('click', loadPendingOrders);
document.getElementById('refreshSales').addEventListener('click', loadSales);
document.getElementById('filterBtn').addEventListener('click', loadPendingOrders);
document.getElementById('clearFilterBtn').addEventListener('click', () => {
    document.getElementById('tableSearch').value = '';
    loadPendingOrders();
});

function initStaffInfo() {
    const name = localStorage.getItem('staffDisplayName') || '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    const role = localStorage.getItem('staffRole') || 'EMPLOYEE';
    staffInfo.innerText = `${name} (${role})`;
}

// -------------------- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô --------------------
async function loadPendingOrders() {
    pendingError.style.display = 'none';
    const tableFilter = document.getElementById('tableSearch').value.trim();
    pendingBody.innerHTML = '<tr><td colspan="5" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
    try {
        const res = await fetch(PENDING_ENDPOINT);
        if (!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${res.status})`);
        const data = await res.json();
        const filtered = tableFilter ? data.filter(order => `${order.tableId}` === tableFilter) : data;
        renderPendingOrders(filtered);
    } catch (err) {
        pendingError.innerText = `‚ùå ${err.message}`;
        pendingError.style.display = 'block';
        pendingBody.innerHTML = '<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ</td></tr>';
    }
}

function renderPendingOrders(orders) {
    if (!orders || orders.length===0) {
        pendingBody.innerHTML = '<tr><td colspan="5" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</td></tr>';
        return;
    }
    pendingBody.innerHTML = orders.map(order => {
        const total = calculateOrderTotal(order);
        const itemsHtml = (order.items||[]).map(item => {
            const name = item.menuItemDetails?.name || item.name || '‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
            const price = resolveItemPrice(item);
            return `<li>${name} √ó ${item.quantity} = ${(price*item.quantity).toFixed(2)} ‡∏ö‡∏≤‡∏ó</li>`;
        }).join('');
        return `<tr>
            <td>#${order.id} <span class="status-pill">${order.status||'COMPLETED'}</span></td>
            <td>${order.tableId ?? '-'}</td>
            <td><ul class="order-items">${itemsHtml}</ul></td>
            <td>${total.toFixed(2)}</td>
            <td><button class="primary" onclick="collectPayment(${order.id}, ${order.tableId ?? 'null'})">‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button></td>
        </tr>`;
    }).join('');
}

async function collectPayment(orderId, tableId) {
    if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${orderId}?`)) return;
    try {
        const endpoint = `${API_BASE}/${orderId}/payment`;
        const res = await fetch(endpoint, {method:'POST'});
        if(!res.ok) throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ (status ${res.status})`);
        const receipt = await res.json();
        showReceipt(orderId, tableId, receipt);
        loadPendingOrders();
        loadSales();
    } catch(err) { alert(`‚ùå ${err.message}`); }
}

function showReceipt(orderId, tableId, receipt) {
    const paidAt = receipt.paidAt ? new Date(receipt.paidAt).toLocaleString('th-TH') : '-';
    const amount = receipt.totalAmount ?? 0;
    receiptContainer.innerHTML = `<div class="receipt-card">
        <h3>üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <p>Order #: <strong>${orderId}</strong></p>
        <p>‡πÇ‡∏ï‡πä‡∏∞: <strong>${tableId ?? receipt.tableId ?? '-'}</strong></p>
        <p>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <strong>${amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</strong></p>
        <p>‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: <strong>${paidAt}</strong></p>
        <p class="muted">${receipt.message??'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'}</p>
    </div>`;
}

// -------------------- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î --------------------
let salesChart = null, menuPieChart = null;

async function loadSales() {
    salesError.style.display='none';
    salesBody.innerHTML='<tr><td colspan="5" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
    try {
        const res = await fetch(SALES_ENDPOINT);
        if(!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${res.status})`);
        const data = await res.json();
        renderSales(data);
        renderSalesChart(data);
        renderMenuPieChart(data);
    } catch(err) {
        salesError.innerText=`‚ùå ${err.message}`;
        salesError.style.display='block';
        salesBody.innerHTML='<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</td></tr>';
        document.getElementById('salesTotal').innerText='0.00';
    }
}

function renderSales(orders) {
    if(!orders||orders.length===0){
        salesBody.innerHTML='<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</td></tr>';
        document.getElementById('salesTotal').innerText='0.00';
        return;
    }
    let totalSales=0;
    salesBody.innerHTML = orders.map(order=>{
        const total=calculateOrderTotal(order);
        totalSales+=total;
        const itemCount=(order.items||[]).reduce((s,i)=>s+i.quantity,0);
        const createdAt = order.createdAt ? new Date(order.createdAt).toLocaleString('th-TH'):'-';
        return `<tr>
            <td>#${order.id}</td>
            <td>${order.tableId??'-'}</td>
            <td>${itemCount}</td>
            <td>${total.toFixed(2)}</td>
            <td>${createdAt}</td>
        </tr>`;
    }).join('');
    document.getElementById('salesTotal').innerText=totalSales.toFixed(2);
}

function calculateOrderTotal(order){
    return (order.items||[]).reduce((sum,item)=>sum + resolveItemPrice(item)*item.quantity,0);
}
function resolveItemPrice(item){
    if(item.menuItemDetails && typeof item.menuItemDetails.price==='number') return item.menuItemDetails.price;
    if(typeof item.price==='number') return item.price;
    return 0;
}

// -------------------- ‡∏Å‡∏£‡∏≤‡∏ü --------------------
function renderSalesChart(orders){
    if(!orders||orders.length===0) return;
    const salesByDate = {};
    orders.forEach(order=>{
        const date = order.createdAt ? new Date(order.createdAt).toLocaleDateString('th-TH'):'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
        salesByDate[date] = (salesByDate[date]||0)+calculateOrderTotal(order);
    });
    const labels=Object.keys(salesByDate);
    const data=Object.values(salesByDate);
    const ctx=document.getElementById('salesChart').getContext('2d');
    if(salesChart) salesChart.destroy();
    salesChart = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)', data, backgroundColor:'rgba(255,193,7,0.7)', borderColor:'#f1c40f', borderWidth:1, borderRadius:6 }]},
        options:{ responsive:true, plugins:{ legend:{display:false}, title:{display:true,text:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', font:{size:16}}}, scales:{ x:{title:{display:true,text:'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'}}, y:{beginAtZero:true,title:{display:true,text:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)'}}} }
    });
}

function renderMenuPieChart(orders){
    if(!orders||orders.length===0) return;
    const today=new Date().toLocaleDateString('th-TH');
    const todayOrders = orders.filter(order=>{
        if(!order.createdAt) return false;
        return new Date(order.createdAt).toLocaleDateString('th-TH')===today;
    });
    if(todayOrders.length===0) return;
    const menuSales={};
    todayOrders.forEach(order=>{
        (order.items||[]).forEach(item=>{
            const name = item.menuItemDetails?.name || item.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π';
            const total = resolveItemPrice(item)*item.quantity;
            menuSales[name]=(menuSales[name]||0)+total;
        });
    });
    const labels=Object.keys(menuSales);
    const data=Object.values(menuSales);
    const ctx=document.getElementById('menuPieChart').getContext('2d');
    if(menuPieChart) menuPieChart.destroy();
    menuPieChart = new Chart(ctx,{
        type:'pie',
        data:{ labels, datasets:[{data, backgroundColor:[
            'rgba(255,99,132,0.7)','rgba(54,162,235,0.7)','rgba(255,206,86,0.7)',
            'rgba(75,192,192,0.7)','rgba(153,102,255,0.7)','rgba(255,159,64,0.7)'
        ], borderColor:'#fff', borderWidth:1 }]},
        options:{ plugins:{ title:{display:true,text:`‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏°‡∏ô‡∏π (${today})`, font:{size:16}}, legend:{position:'bottom'} } }
    });
}

document.addEventListener('DOMContentLoaded',()=>{
    initStaffInfo();
    loadPendingOrders();
    loadSales();
});
</script>
</body>
</html>